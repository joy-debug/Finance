<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Finance PWA — Release Version</title>
<meta name="description" content="Un'applicazione PWA per la gestione delle finanze personali, completa di grafici, calendario e funzionalità offline."/>
<meta name="theme-color" content="#0b1220" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2306b6d4'/></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%2306b6d4'/></svg>">
<style>
:root{
  --bg:#071023; --card:#0c1427; --muted:#8a9bb3; --accent:#06b6d4; --glass: rgba(255,255,255,0.03);
  --success:#22c55e; --danger:#ef4444; --radius:16px; --pad:16px; --shadow: 0 8px 30px rgba(2,6,23,0.6);
  --toast-bg: rgba(10,12,18,0.9);
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
html{font-size:16px;}
body{margin:0;padding-bottom:80px;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;color:#e6efef;background:var(--bg);-webkit-font-smoothing:antialiased}
.app{max-width:900px;margin:0 auto;padding:var(--pad);}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;}
.brand{display:flex;gap:12px;align-items:center;}
.logo{width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--bg);}
h1{font-size:1.15rem;margin:0}
.header-actions{display:flex;gap:8px;align-items:center}

/* Buttons */
.btn{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.08);padding:8px 12px;border-radius:10px;color:inherit;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:0.9rem;transition:transform 0.12s ease;}
.btn:active{transform:scale(0.98)}
.btn.primary{background:var(--accent);color:var(--bg);border-color:var(--accent);}
.btn-sm{padding:6px 8px; font-size:0.8rem; border-radius:8px;}
.icon-btn{width:40px;height:40px;border-radius:8px;display:inline-flex;align-items:center;justify-content:center}

/* Main Views */
.view{display:none;}
.view.active{display:block; animation: fadeIn 0.26s ease-in-out;}
@keyframes fadeIn { from { opacity: 0; transform:translateY(6px); } to { opacity: 1; transform:translateY(0); } }

/* Home View */
.top-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px}
.search{flex:1;display:flex;gap:8px}
.search input, .filter select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.2);color:inherit;width:100%}
.balance-card{background:linear-gradient(145deg, #101a30, #0c1427); padding:20px; border-radius:var(--radius); text-align:center; margin-bottom:14px;}
.balance-card .label{font-size:0.9rem; color:var(--muted); margin-bottom:6px;}
.balance-card .amount{font-size:2.2rem; font-weight:700; color:#fff;}
.tx-list{list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;}
.tx-item{background:var(--card); padding:10px; border-radius:12px; display:flex; align-items:center; gap:12px;}
.tx-item .icon{width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.2rem; background:var(--glass); flex-shrink:0;}
.tx-item .details{flex:1; min-width:0;}
.tx-item .description{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
.tx-item .category{font-size:0.8rem; color:var(--muted);}
.tx-item .right-section{text-align:right; min-width:120px;}
.tx-item .amount{font-weight:700; font-size:1.05rem;}
.tx-item .amount.income{color:var(--success);}
.tx-item .amount.expense{color:var(--danger);}
.tx-item .actions{display:flex; gap:8px; margin-top:6px; justify-content:flex-end;}

/* Actions View */
.actions-grid{display:grid; grid-template-columns:1fr; gap:12px;}
@media(min-width: 760px) { .actions-grid{grid-template-columns:1fr 1fr;} }
.action-card{background:var(--card); padding:var(--pad); border-radius:var(--radius); text-align:center; cursor:pointer; transition: background 0.16s ease;}
.action-card:hover{background:rgba(255,255,255,0.04);}
.action-card .icon{font-size:1.9rem; margin-bottom:8px;}
.action-card .title{font-weight:600;}

/* Charts */
.chart-filters{display:flex;gap:10px;align-items:center;margin-bottom:12px;background:var(--card);padding:8px;border-radius:12px;}
.chart-filters label{font-size:0.9rem;font-weight:600;}
.chart-filters select{flex:1;}
.chart-toggle{display:flex; background:var(--card); border-radius:12px; padding:4px; margin-bottom:12px; flex-wrap: wrap;}
.chart-toggle .btn{flex:1; justify-content:center; background:transparent; border:none; min-width:100px;}
.chart-toggle .btn.active{background:var(--accent); color:var(--bg);}
.chart-container{height:clamp(280px, 44vh, 420px); position:relative;}
.hidden{display:none !important;}
canvas{width:100% !important; height:100% !important; display:block;}

/* Calendar */
#calendar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
#calendar-month-year{font-size:1.1rem;font-weight:700}
#calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.calendar-day{background:var(--card);border-radius:8px;min-height:80px;padding:8px;font-size:0.8rem; cursor:pointer;}
.calendar-day.other-month{opacity:0.3; pointer-events:none;}

/* FAB */
.fab{position:fixed; bottom:110px; right:22px; width:56px; height:56px; border-radius:50%; background:var(--accent); color:var(--bg); border:none; font-size:1.9rem; display:flex; align-items:center; justify-content:center; box-shadow:0 12px 30px rgba(6, 182, 212, 0.22); z-index:40;}

/* Bottom Nav */
.bottom-nav{position:fixed; bottom:0; left:0; right:0; background:rgba(12, 20, 39, 0.9); backdrop-filter:blur(8px); display:flex; justify-content:space-around; padding:10px 0; border-top:1px solid rgba(255,255,255,0.06); z-index:120;}
.nav-btn{background:none; border:none; color:var(--muted); font-size:1.5rem; padding:8px 16px; cursor:pointer; border-radius:12px; transition:all 0.16s ease;}
.nav-btn.active{color:var(--accent); background:rgba(6, 182, 212, 0.08);}

/* Modal - raised above bottom-nav */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(4,6,12,0.6);z-index:1400;}
.modal.active{display:flex;}
.modal-content{background:var(--card);width:100%;max-width:720px;max-height:calc(100vh - 130px);padding:18px;border-radius:14px 14px 10px 10px;box-shadow:var(--shadow);overflow-y:auto;animation:slideInUp 0.26s ease;margin-bottom:88px;padding-bottom:calc(18px + env(safe-area-inset-bottom, 12px));}
.modal-content h3{margin-top:0;}
@keyframes slideInUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.form-row{margin-bottom:12px;}
.form-row label{display:block;font-size:0.9rem;color:var(--muted);margin-bottom:6px;}
.input,select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.18);color:inherit;width:100%;font-size:1rem;}
.type-toggle{display:flex;gap:8px;}
.type-toggle .btn{flex:1;text-align:center;justify-content:center;}
.type-toggle .btn.active{background:var(--accent);color:var(--bg);}

/* Toast / Snackbar */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:86px;background:var(--toast-bg);color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,0.6);display:flex;gap:12px;align-items:center;z-index:1600;max-width:92%;font-size:0.95rem;}
.toast .action{background:transparent;border:0;color:var(--accent);cursor:pointer;font-weight:700;padding:6px;border-radius:8px}

/* small utilities */
.row{display:flex;gap:8px;align-items:center}
.hidden-visually{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;}
#installBtn.hidden { display: none; }
</style>
</head>
<body>

<div class="app" role="application" aria-label="Finanza">
  <div class="header">
    <div class="brand"><div class="logo">F</div><h1>Finanza</h1></div>
    <div class="header-actions">
      <button id="voiceBtn" class="btn icon-btn" title="Aggiungi con Voce">🎤</button>
      <button id="fullscreenBtn" class="btn icon-btn" title="Fullscreen">⤢</button>
      <button id="installBtn" class="btn hidden" title="Installa PWA">📱 Installa</button>
    </div>
  </div>

  <!-- Top controls / search -->
  <div class="top-controls">
    <div class="search" style="flex:1">
      <input id="txSearch" placeholder="Cerca transazioni..." aria-label="Cerca transazioni">
    </div>
    <div class="filter">
      <select id="categoryFilter" aria-label="Filtra per categoria">
        <option value="">Tutte le categorie</option>
      </select>
    </div>
  </div>

  <!-- VISTA HOME -->
  <div id="homeView" class="view active">
      <div class="balance-card" role="region" aria-label="Saldo">
        <div class="label">Saldo Attuale</div>
        <div class="amount" id="balance">€0.00</div>
      </div>
      <h3 style="margin-bottom:12px;">Transazioni Recenti</h3>
      <ul id="tx-list" class="tx-list" role="list" aria-label="Lista transazioni"></ul>
  </div>

  <!-- VISTA GRAFICI -->
  <div id="graficiView" class="view" aria-hidden="true">
      <h2>Grafici e Analisi</h2>
       <div class="chart-filters">
            <label for="chartYearFilter">Anno:</label>
            <select id="chartYearFilter" class="input" aria-label="Filtra grafici per anno"></select>
        </div>
      <div class="chart-toggle" role="tablist" aria-label="Selezione grafici">
          <button class="btn active" data-chart="monthly" role="tab" aria-selected="true">Mensile</button>
          <button class="btn" data-chart="category" role="tab" aria-selected="false">Categorie</button>
          <button class="btn" data-chart="yearly" role="tab" aria-selected="false">Annuale</button>
          <button class="btn" data-chart="balance" role="tab" aria-selected="false">Andamento</button>
      </div>
      <div class="chart-container" role="region" aria-label="Grafici">
          <canvas id="monthlyChart" aria-hidden="false"></canvas>
          <canvas id="categoryChart" class="hidden" aria-hidden="true"></canvas>
          <canvas id="yearlyChart" class="hidden" aria-hidden="true"></canvas>
          <canvas id="balanceTrendChart" class="hidden" aria-hidden="true"></canvas>
      </div>
  </div>

  <!-- VISTA CALENDARIO -->
  <div id="calendarView" class="view" aria-hidden="true">
      <div id="calendar-header">
          <button id="prev-month-btn" class="btn" aria-label="Mese precedente">&lt;</button>
          <div id="calendar-month-year" aria-live="polite"></div>
          <button id="next-month-btn" class="btn" aria-label="Mese successivo">&gt;</button>
      </div>
      <div id="calendar-weekdays" style="display:grid;grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom: 6px; font-weight: 600; color: var(--muted); font-size: 0.8rem;"></div>
      <div id="calendar-grid" tabindex="0"></div>
  </div>

  <!-- VISTA AZIONI -->
  <div id="actionsView" class="view" aria-hidden="true">
      <h2>Azioni</h2>
      <div class="actions-grid">
          <div id="ocrBtn" class="action-card" role="button" tabindex="0"><div class="icon">📷</div><div class="title">Carica Screenshot Conto</div><input id="imgInput" type="file" accept="image/*" style="display:none"></div>
          <div id="manageCatsBtn" class="action-card" role="button" tabindex="0"><div class="icon">🏷️</div><div class="title">Gestisci Categorie</div></div>
          <div id="manageRecurringBtn" class="action-card" role="button" tabindex="0"><div class="icon">🔁</div><div class="title">Gestisci Ricorrenti</div></div>
          <div id="importCsvBtn" class="action-card" role="button" tabindex="0"><div class="icon">📁</div><div class="title">Importa CSV</div><input id="file" type="file" accept=".csv" style="display:none"></div>
          <div id="exportBackupBtn" class="action-card" role="button" tabindex="0"><div class="icon">💾</div><div class="title">Esporta Transazioni (CSV)</div></div>
      </div>
  </div>
</div>

<button id="fab-add" class="fab" aria-label="Aggiungi">+</button>

<nav class="bottom-nav" id="bottom-nav" aria-hidden="false">
    <button class="nav-btn active" data-view="homeView" aria-label="Home">🏠</button>
    <button class="nav-btn" data-view="calendarView" aria-label="Calendario">📅</button>
    <button class="nav-btn" data-view="graficiView" aria-label="Grafici">📊</button>
    <button class="nav-btn" data-view="actionsView" aria-label="Azioni">✨</button>
</nav>

<!-- MODALI -->
<div id="addModal" class="modal" aria-hidden="true"><div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle"><h3 id="modalTitle"></h3><input type="hidden" id="editId"><div class="form-row"><label for="mDate">Data</label><input id="mDate" class="input" type="date"></div><div class="form-row"><label for="mDesc">Descrizione</label><input id="mDesc" class="input"></div><div class="form-row"><label for="mAmt">Importo</label><input id="mAmt" class="input" type="number" step="0.01"></div><div class="form-row"><label>Tipo</label><div class="type-toggle" id="typeToggle"><button class="btn active" data-type="expense" aria-pressed="true">Uscita</button><button class="btn" data-type="income" aria-pressed="false">Entrata</button></div></div><div class="form-row"><label for="mCat">Categoria</label><select id="mCat" class="input"></select></div><div class="form-row" style="display:flex; gap:10px; margin-top:12px;"><button id="cancelAdd" class="btn" style="flex:1;">Annulla</button><button id="saveAdd" class="btn primary" style="flex:2;">Salva</button></div></div></div>

<div id="categoryModal" class="modal" aria-hidden="true"><div class="modal-content" role="dialog" aria-modal="true"><h3>Gestisci Categorie</h3><div id="categoryList"></div><hr><input type="hidden" id="catId"><div class="form-row"><input id="catName" class="input" placeholder="Nome categoria"></div><div class="form-row"><input id="catIcon" class="input" placeholder="Icona (es. 🛒)"></div><div class="form-row" style="display:flex;gap:10px;"><button id="saveCat" class="btn primary" style="flex:1">Salva</button><button id="clearCatForm" class="btn" style="flex:1">Nuova</button></div></div></div>

<div id="recurringModal" class="modal" aria-hidden="true"><div class="modal-content" role="dialog" aria-modal="true"><h3>Transazioni Ricorrenti</h3><div id="recurringList"></div><hr><h3>Aggiungi Ricorrente</h3><div class="form-row"><input id="rDesc" class="input" placeholder="Descrizione"></div><div class="form-row"><input id="rAmt" class="input" type="number" placeholder="Importo (es. -50 per uscita)"></div><div class="form-row"><select id="rFreq" class="input"><option value="weekly">Settimanale</option><option value="monthly">Mensile</option></select></div><div class="form-row"><label>Prossima data di esecuzione</label><input id="rDate" type="date" class="input"></div><div class="form-row"><button id="rAdd" class="btn primary">Aggiungi Ricorrente</button></div></div></div>

<div id="dayDetailModal" class="modal" aria-hidden="true"><div class="modal-content" role="dialog" aria-modal="true"><h3 id="dayDetailTitle"></h3><div id="dayDetailList"></div></div></div>

<!-- Toast area placeholder -->
<div id="toastHolder" aria-live="polite" style="position:fixed;left:50%;transform:translateX(-50%);bottom:86px;z-index:1700"></div>

<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(async function(){
    /* ---------- State & helpers ---------- */
    const STORAGE = 'pf_pwa_v10_final';
    let state = { transactions:[], categories:[], recurring:[], deferredInstallPrompt:null };
    let calendarCurrentDate = new Date();
    let chartInstances = {}; // Store all chart instances
    let lastDeleted = null, undoTimeout = null;
    const $ = (sel) => {
        if (!sel) return null; if (typeof sel !== 'string') return sel; if (/^[a-zA-Z0-9_\-]+$/.test(sel)) return document.getElementById(sel);
        if (sel[0] === '#' && /^[#][a-zA-Z0-9_\-]+$/.test(sel)) return document.getElementById(sel.slice(1));
        const nodelist = document.querySelectorAll(sel); return nodelist.length === 1 ? nodelist[0] : nodelist;
    };
    const nowISO = () => new Date().toISOString().slice(0, 10);
    const fmt = n => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(n);
    const parseAmount = s => {
        if (s === undefined || s === null) return 0;
        let str = String(s).trim().replace(/€/g, '').replace(/\s/g, '');
        // If a comma is present, assume it's the decimal separator and periods are for thousands.
        if (str.includes(',')) {
            str = str.replace(/\./g, '').replace(',', '.');
        }
        // If no comma, a period is assumed to be the decimal separator, so we don't touch it.
        return isNaN(Number(str)) ? 0 : Number(str);
    };
    const save = () => localStorage.setItem(STORAGE, JSON.stringify(state));
    const load = () => { const r = localStorage.getItem(STORAGE); if(r) try { state = JSON.parse(r) } catch(e) { state = { transactions:[], categories:[], recurring:[] } }; state = { transactions:[], categories:[], recurring:[], ...state }; };
    const escapeHtml = s => String(s).replace(/[&<>"]+/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;'})[m] || m);

    /* ---------- Toast / Snackbar ---------- */
    function showToast(message, actionLabel, actionCb, timeout = 6000) {
        const holder = $('toastHolder'); if (!holder) return; holder.innerHTML = '';
        const el = document.createElement('div'); el.className = 'toast';
        el.innerHTML = `<div style="flex:1">${escapeHtml(message)}</div>`;
        if (actionLabel && actionCb) {
            const btn = document.createElement('button'); btn.className = 'action'; btn.textContent = actionLabel;
            btn.addEventListener('click', () => { actionCb(); holder.innerHTML=''; clearTimeout(undoTimeout); });
            el.appendChild(btn);
        }
        holder.appendChild(el);
        if (timeout) undoTimeout = setTimeout(() => { if (holder.contains(el)) holder.removeChild(el); undoTimeout = null; }, timeout);
    }

    /* ---------- Defaults & guess ---------- */
    function guessCategory(description) {
      const desc = (description || '').toLowerCase();
      const mapping = {
          'Carburante': ['eni','q8','ip','tamoil','esso','shell','autostrade','telepass','benzina','diesel','metano'], 'Supermercato': ['conad','esselunga','coop','carrefour','lidl','eurospin','md','todis','bennet','gigante','iperal','spesa','discount'],
      		'Utenze': ['enel','a2a','iren','hera','acea','tim','vodafone','wind','tre','iliad','fastweb','bolletta'],'Ristorazione': ["mcdonald",'burger','poke','sushi','glovo','just eat','deliveroo','ristorante','pizzeria','bar','autogrill','caff','caffè','cafe','panino','caffetteria','bar tabacchi','pasticceria','trattoria'],
          'Shopping': ['amazon','zalando','zara','h&m','decathlon','mediaworld','unieuro','leroy','ikea','apple'], 'Trasporti': ['trenitalia','italo','atm','atac','trenord','flixbus','autobus','biglietto','taxi','uber'],
          'Salute': ['farmacia','medic','ospedale','visita','fisioterapia'], 'Investimenti': ['directa','fineco','degiro','trade republic']
      };
      for (const category in mapping) { if (mapping[category].some(keyword => desc.includes(keyword))) return category; } return '';
    }
    function ensureDefaults() {
      if (!state.categories || !state.categories.length) {
          state.categories = [
            {id:'cat_stipendio', name:'Stipendio', icon:'💼'}, {id:'cat_spesa', name:'Supermercato', icon:'🛒'}, {id:'cat_utenze', name:'Utenze', icon:'💡'}, {id:'cat_carburante', name:'Carburante', icon:'⛽️'},
            {id:'cat_ristorazione', name:'Ristorazione', icon:'🍔'}, {id:'cat_shopping', name:'Shopping', icon:'🛍️'}, {id:'cat_trasporti', name:'Trasporti', icon:'🚌'},
            {id:'cat_salute', name:'Salute', icon:'⚕️'}, {id:'cat_investimenti', name:'Investimenti', icon:'📈'}
          ];
          save();
      }
    }

    /* ---------- Renderers ---------- */
    function updateUI() {
        renderTransactionList(); renderBalance(); renderCategoriesSelect(); refreshCategoryFilterOptions();
        if ($('graficiView')?.classList.contains('active')) { populateChartYearFilter(); updateCharts(); }
        if ($('calendarView')?.classList.contains('active')) renderCalendar();
    }
    function renderBalance() { $('balance').textContent = fmt(state.transactions.reduce((s, t) => s + (t.amount || 0), 0)); }
    function renderTransactionList(filterText = '', filterCat = '') {
        const list = $('tx-list'); const rows = state.transactions.slice().sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        const filtered = rows.filter(t => {
            const ft = (t.description || '').toLowerCase(); const matchesText = !filterText || ft.includes(filterText.toLowerCase());
            const matchesCat = !filterCat || (t.category === filterCat); return matchesText && matchesCat;
        });
        list.innerHTML = filtered.slice(0, 500).map(t => {
            const cat = state.categories.find(c => c.name === t.category);
            return `<li class="tx-item" data-id="${t.id}" role="listitem">
                <div class="icon" aria-hidden="true">${cat?.icon || '🏷️'}</div>
                <div class="details"><div class="description">${escapeHtml(t.description||'')}</div><div class="category">${escapeHtml(t.category||'N/D')} · ${escapeHtml(t.date||'')}</div></div>
                <div class="right-section"><div class="amount ${t.type}">${fmt(t.amount||0)}</div><div class="actions"><button class="btn-sm" data-action="edit" aria-label="Modifica">✏️</button><button class="btn-sm" data-action="delete" aria-label="Elimina">🗑️</button></div></div>
            </li>`;
        }).join('');
    }
    function renderCategoriesSelect() { const sel = $('mCat'); if (!sel) return; sel.innerHTML = state.categories.map(c => `<option value="${escapeHtml(c.name)}">${c.icon} ${escapeHtml(c.name)}</option>`).join('') + '<option value="">Non categorizzato</option>'; }
    function refreshCategoryFilterOptions() {
        const f = $('categoryFilter'); if (!f) return; const cur = f.value;
        f.innerHTML = `<option value="">Tutte le categorie</option>` + state.categories.map(c => `<option value="${escapeHtml(c.name)}">${c.icon} ${escapeHtml(c.name)}</option>`).join('');
        f.value = cur || '';
    }

    /* ---------- Charts ---------- */
    const chartOptions = {responsive:true, maintainAspectRatio:false, scales:{x:{ticks:{color:'#9fb0c9'}},y:{ticks:{color:'#9fb0c9'}}}, plugins:{legend:{labels:{color:'#e6efef'}}}};
    function destroyChart(id) { if(chartInstances[id]) { chartInstances[id].destroy(); delete chartInstances[id]; } }
    function renderChart(id, type, data, options = chartOptions) { destroyChart(id); const ctx = $(`#${id}`)?.getContext('2d'); if(ctx) chartInstances[id] = new Chart(ctx, { type, data, options }); }
    
    function renderMonthlyChart(year) {
        const filteredTx = state.transactions.filter(t => t.date.startsWith(year));
        const monthly = {};
        filteredTx.forEach(t => { const m = t.date.slice(0, 7); if (!m) return; if (!monthly[m]) monthly[m] = { income: 0, expense: 0 };
            if (t.type === 'income') monthly[m].income += t.amount || 0; else monthly[m].expense += Math.abs(t.amount || 0);
        });
        const labels = Object.keys(monthly).sort();
        const data = { labels, datasets: [ { label: 'Entrate', data: labels.map(m => monthly[m].income), backgroundColor: 'rgba(34,197,94,0.7)' }, { label: 'Uscite', data: labels.map(m => monthly[m].expense), backgroundColor: 'rgba(239,68,68,0.7)' } ] };
        renderChart('monthlyChart', 'bar', data);
    }
    function renderCategoryChart(year) {
        const byCat = {};
        state.transactions.filter(t => t.type === 'expense' && t.date.startsWith(year)).forEach(t => {
            const cat = t.category || 'Non categorizzato'; byCat[cat] = (byCat[cat] || 0) + Math.abs(t.amount || 0);
        });
        const labels = Object.keys(byCat);
        const data = { labels, datasets: [{ data: labels.map(l => byCat[l] || 0), backgroundColor: ['#ef4444','#f97316','#eab308','#84cc16','#22c55e','#10b981','#06b6d4','#3b82f6','#8b5cf6','#d946ef'] }]};
        renderChart('categoryChart', 'pie', data, {...chartOptions, plugins: { legend: { position: 'bottom', labels: { color: '#e6efef' } }, tooltip: { callbacks: { label: c => `${c.label}: ${fmt(c.parsed)}` } } }});
    }
    function renderYearlyChart(year) {
        const monthly = Array(12).fill(0).map(() => ({ income: 0, expense: 0 }));
        state.transactions.filter(t => t.date.startsWith(year)).forEach(t => {
            const monthIndex = new Date(t.date).getMonth();
            if (t.type === 'income') monthly[monthIndex].income += t.amount; else monthly[monthIndex].expense += Math.abs(t.amount);
        });
        const labels = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
        const data = { labels, datasets: [ { label: 'Entrate', data: monthly.map(m => m.income), backgroundColor: 'rgba(34,197,94,0.7)' }, { label: 'Uscite', data: monthly.map(m => m.expense), backgroundColor: 'rgba(239,68,68,0.7)' } ] };
        renderChart('yearlyChart', 'bar', data);
    }
    function renderBalanceTrendChart(year) {
        const initialBalance = state.transactions.filter(t => new Date(t.date).getFullYear() < year).reduce((sum, t) => sum + t.amount, 0);
        const yearTx = state.transactions.filter(t => t.date.startsWith(year)).sort((a,b) => a.date.localeCompare(b.date));
        let runningBalance = initialBalance;
        const dailyBalances = {};
        for(const t of yearTx) { runningBalance += t.amount; dailyBalances[t.date] = runningBalance; }
        const dataPoints = Object.entries(dailyBalances).map(([date, balance]) => ({x: new Date(date), y: balance}));
        const data = { datasets: [{ label: 'Andamento Saldo', data: dataPoints, borderColor: 'var(--accent)', tension: 0.1, fill: false }] };
        const options = {...chartOptions, scales: { x: { type: 'time', time: { unit: 'month' }, ticks:{color:'#9fb0c9'}}, y: {ticks:{color:'#9fb0c9'}} }};
        renderChart('balanceTrendChart', 'line', data, options);
    }
    function updateCharts() {
        const year = $('#chartYearFilter')?.value || new Date().getFullYear(); const activeChart = document.querySelector('.chart-toggle .btn.active')?.dataset.chart || 'monthly';
        const chartIds = ['monthlyChart', 'categoryChart', 'yearlyChart', 'balanceTrendChart'];
        chartIds.forEach(id => $(`#${id}`)?.classList.add('hidden'));
        const chartRenderers = { monthly: renderMonthlyChart, category: renderCategoryChart, yearly: renderYearlyChart, balance: renderBalanceTrendChart };
        const selectedRenderer = chartRenderers[activeChart];
        if (selectedRenderer) { $(`#${chartIds.find(id => id.startsWith(activeChart))}`).classList.remove('hidden'); selectedRenderer(year); }
    }
    function populateChartYearFilter() {
        const el = $('#chartYearFilter'); if (!el) return;
        const years = [...new Set(state.transactions.map(t => t.date.slice(0,4)))].sort((a,b) => b-a);
        const currentYear = new Date().getFullYear().toString(); if (!years.includes(currentYear)) years.unshift(currentYear);
        el.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join(''); el.value = currentYear;
    }
    $('.chart-toggle').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn'); if(!btn) return;
        $('.chart-toggle .btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateCharts();
    });
    $('#chartYearFilter')?.addEventListener('change', updateCharts);

    /* ---------- Actions & OCR ---------- */
    const addTransaction = (t) => { t.id=(Date.now() + Math.floor(Math.random()*1000)); state.transactions.push(t); save(); updateUI(); }
    const updateTransaction = (t_new) => { const idx=state.transactions.findIndex(t=>t.id==t_new.id); if(idx>-1){state.transactions[idx]=t_new; save(); updateUI();}}
    const deleteTransaction = (id) => {
        const idx = state.transactions.findIndex(t => String(t.id) === String(id)); if (idx === -1) return;
        const [item] = state.transactions.splice(idx,1); save(); updateUI();
        lastDeleted = item;
        showToast('Transazione eliminata', 'Annulla', () => {
            if (lastDeleted) { state.transactions.push(lastDeleted); state.transactions.sort((a,b)=> (b.date||'').localeCompare(a.date||'')); save(); updateUI(); lastDeleted = null; }
        });
    };
    $('ocrBtn')?.addEventListener('click', () => $('imgInput')?.click());
    $('imgInput')?.addEventListener('change', async (e) => {
        const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => processImageOCR(ev.target.result); r.readAsDataURL(f); e.target.value = '';
    });
    async function processImageOCR(imageDataURL) {
        if (!imageDataURL) return; showToast('Scansione OCR avviata...');
        try {
            const worker = await Tesseract.createWorker('ita'); const { data: { text } } = await worker.recognize(imageDataURL); await worker.terminate();
            const lines = text.split('\n').filter(l => l.trim().length > 3); let addedCount = 0;
            lines.forEach(line => {
                const amountMatch = line.match(/([\+]\s*)?(\d{1,3}(?:[.]\d{3})*,\d{2})/); if (!amountMatch) return;
                const isIncome = !!amountMatch[1], amountStr = amountMatch[2]; let amount = parseAmount(amountStr);
                const description = line.replace(amountMatch[0], '').replace(/[^a-zA-Z0-9\s]/g, ' ').trim(); if (description.length < 2 || amount === 0) return;
                const type = isIncome ? 'income' : 'expense'; if (type === 'expense') amount = -Math.abs(amount);
                addTransaction({ date: nowISO(), description, amount, type, category: guessCategory(description) }); addedCount++;
            });
            showToast(addedCount > 0 ? `Aggiunti ${addedCount} movimenti.` : `Nessun movimento trovato.`);
        } catch (err) { showToast('Errore OCR: ' + (err?.message || err)); }
    }

    /* ---------- Voice Recognition ---------- */
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const voiceBtn = $('#voiceBtn');
    if (!SpeechRecognition) { if(voiceBtn) voiceBtn.style.display = 'none'; } else {
        const recognition = new SpeechRecognition(); recognition.lang = 'it-IT'; recognition.interimResults = false;
        voiceBtn.addEventListener('click', () => { try { recognition.start(); showToast('In ascolto...', null, null, 3000); } catch(e) { showToast('Riconoscimento già attivo.'); }});
        recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; processVoiceCommand(transcript); };
        recognition.onerror = (event) => { showToast(`Errore: ${event.error}`); };
    }
    function processVoiceCommand(transcript) {
        const amountRegex = /(\d+([.,]\d{1,2})?)\s*(euro|eur|€)/i; const amountMatch = transcript.match(amountRegex);
        if (!amountMatch) { showToast('Importo non capito. Prova a dire "spesa di 10 euro per caffè".'); return; }
        let amount = parseFloat(amountMatch[1].replace(',', '.')); let type = 'expense';
        if (/(entrata|accredito|ricevuto|guadagnato)/i.test(transcript)) { type = 'income'; }
        if (type === 'expense') amount = -Math.abs(amount); else amount = Math.abs(amount);
        let description = transcript.replace(amountRegex, '').replace(/(aggiungi|registra|nuova|nuovo|un'|un|una|spesa|costo|uscita|entrata|accredito|di|per|da)/gi, '').replace(/\s\s+/g, ' ').trim();
        description = description.charAt(0).toUpperCase() + description.slice(1) || 'Transazione vocale';
        addTransaction({ date: nowISO(), description, amount, type, category: guessCategory(description) || '' });
        showToast(`Aggiunto: ${description} (${fmt(amount)})`);
    }

    /* ---------- CSV import/export ---------- */
    $('importCsvBtn')?.addEventListener('click', () => $('file')?.click());
    $('file')?.addEventListener('change', e => {
        const f = e.target.files[0]; if(!f) return; const r = new FileReader();
        r.onload = ev => {
            const rows = parseCSV(ev.target.result);
            if(rows.length > 0) { rows.forEach(row => addTransaction(row)); showToast(`Importate ${rows.length} transazioni`); }
            else { showToast('Nessuna transazione valida trovata'); }
        };
        r.readAsText(f);
    });
    function parseCSV(text) {
        const rows = []; const lines = text.split(/\r?\n/); if(!lines.length) return rows; const sep = lines[0].includes(';') ? ';' : ',';
        const header = lines[0].split(sep).map(h => h.trim().toLowerCase());
        for(let i=1; i<lines.length; i++) {
            if(!lines[i].trim()) continue; const cols = lines[i].split(sep); const obj = {}; header.forEach((h,idx) => obj[h] = cols[idx] || '');
            let amount = parseAmount(obj.amount || obj.importo || '0'); const type = (obj.type || '').toLowerCase() || (amount >= 0 ? 'income' : 'expense');
            if (type === 'expense' && amount > 0) amount = -amount; if(!obj.date || !obj.description) continue;
            rows.push({ date: obj.date.slice(0,10), description: obj.description, amount, type, category: obj.category || guessCategory(obj.description)});
        }
        return rows;
    }
    function exportTransactionsToCSV() {
        if (!state.transactions || !state.transactions.length) return showToast('Nessuna transazione da esportare');
        const header = ['date', 'description', 'amount', 'type', 'category'];
        const csvRows = state.transactions.map(t => [t.date, `"${String(t.description || '').replace(/"/g, '""')}"`, t.amount || 0, t.type, `"${String(t.category || '').replace(/"/g, '""')}"`].join(','));
        const csv = [header.join(',')].concat(csvRows).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = `finanza_esportazione_${nowISO()}.csv`; a.click(); URL.revokeObjectURL(url);
        showToast('CSV esportato con successo');
    }
    $('exportBackupBtn')?.addEventListener('click', exportTransactionsToCSV);

    /* ---------- View & Modal Management ---------- */
    const views = $('.view'), navBtns = $('.nav-btn');
    function showView(viewId) {
        views.forEach(v => v.classList.remove('active')); navBtns.forEach(b => b.classList.remove('active'));
        $(`#${viewId}`)?.classList.add('active'); $(`.nav-btn[data-view="${viewId}"]`)?.classList.add('active');
        if (viewId === 'calendarView') renderCalendar();
        if (viewId === 'graficiView') { populateChartYearFilter(); updateCharts(); }
    }
    $('#bottom-nav')?.addEventListener('click', e => { const b=e.target.closest('.nav-btn'); if(b) showView(b.dataset.view); });
    const showModal = id => { const el = $(`#${id}`); if(el) {el.classList.add('active'); el.setAttribute('aria-hidden','false');} };
    const hideModal = id => { const el = $(`#${id}`); if(el) {el.classList.remove('active'); el.setAttribute('aria-hidden','true');} };
    document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target.id === m.id) hideModal(m.id); }));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') $('.modal.active').forEach(m => hideModal(m.id)); });

    /* ---------- Add/Edit Modal ---------- */
    $('fab-add')?.addEventListener('click', () => {
        $('#modalTitle').textContent = 'Aggiungi Transazione'; $('#editId').value = ''; $('#mDate').value = nowISO(); $('#mDesc').value = ''; $('#mAmt').value = '';
        $('#typeToggle .btn').forEach(b => b.classList.remove('active')); $('#typeToggle .btn[data-type="expense"]').classList.add('active');
        showModal('addModal');
    });
    $('tx-list')?.addEventListener('click', e => {
        const btn = e.target.closest('button'); if(!btn) return; const item = e.target.closest('.tx-item'); if(!item || !item.dataset.id) return;
        const id = item.dataset.id;
        if (btn.dataset.action === 'edit') {
            const tx = state.transactions.find(t => String(t.id) === id); if(!tx) return;
            $('#modalTitle').textContent = 'Modifica Transazione'; $('#editId').value = tx.id; $('#mDate').value = tx.date; $('#mDesc').value = tx.description; $('#mAmt').value = Math.abs(tx.amount); $('#mCat').value = tx.category||'';
            $('#typeToggle .btn').forEach(b => b.classList.toggle('active', b.dataset.type === tx.type));
            showModal('addModal');
        } else if (btn.dataset.action === 'delete' && confirm('Eliminare questa transazione?')) deleteTransaction(id);
    });
    $('#typeToggle').addEventListener('click', e => { const b = e.target.closest('.btn'); if (!b) return; $('#typeToggle .btn').forEach(x => x.classList.remove('active')); b.classList.add('active'); });
    $('cancelAdd')?.addEventListener('click', () => hideModal('addModal'));
    $('saveAdd')?.addEventListener('click', () => {
        const id=$('#editId').value, type=$('#typeToggle .btn.active')?.dataset.type || 'expense'; let amt=parseAmount($('#mAmt').value);
        if (type==='expense'&&amt>0) amt=-amt; if (type==='income'&&amt<0) amt=Math.abs(amt);
        const t = {id:id?Number(id):null,date:$('#mDate').value||nowISO(),description:$('#mDesc').value||'Manuale',amount:amt,type,category:$('#mCat').value||guessCategory($('#mDesc').value)||''};
        if (id) updateTransaction(t); else addTransaction(t);
        hideModal('addModal');
    });

    /* ---------- Category Management ---------- */
    $('manageCatsBtn')?.addEventListener('click', () => { renderCategoryManagerList(); showModal('categoryModal'); });
    function renderCategoryManagerList() { $('#categoryList').innerHTML = state.categories.map(c => `<div class="row" style="justify-content:space-between; padding: 4px 0;"><span>${c.icon} ${escapeHtml(c.name)}</span><div><button class="btn-sm" data-action="edit-cat" data-id="${c.id}">✏️</button><button class="btn-sm" data-action="delete-cat" data-id="${c.id}">🗑️</button></div></div>`).join('') || "<p>Nessuna categoria.</p>"; }
    $('categoryList')?.addEventListener('click', e => {
        const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id;
        if(btn.dataset.action === 'delete-cat' && confirm('Eliminare questa categoria?')) {
            state.categories = state.categories.filter(c => c.id != id);
            state.transactions.forEach(t => { if (t.category && !state.categories.find(c=>c.name===t.category)) t.category = ''; });
            save(); renderCategoryManagerList(); updateUI();
        } else if(btn.dataset.action === 'edit-cat') { const cat = state.categories.find(c => c.id == id); if (cat) { $('#catId').value = cat.id; $('#catName').value = cat.name; $('#catIcon').value = cat.icon; } }
    });
    $('clearCatForm')?.addEventListener('click', () => { $('#catId').value = ''; $('#catName').value = ''; $('#catIcon').value = ''; });
    $('saveCat')?.addEventListener('click', () => {
        const id = $('#catId').value, name = $('#catName').value.trim(), icon = $('#catIcon').value || '🏷️'; if (!name) return showToast('Il nome è obbligatorio');
        if (id) { const cat = state.categories.find(c => c.id == id); if (cat) Object.assign(cat, {name, icon}); } 
        else { state.categories.push({ id: 'cat_' + Date.now(), name, icon }); }
        save(); renderCategoryManagerList(); updateUI(); $('#catId').value = ''; $('#catName').value = ''; $('#catIcon').value = '';
    });
    
    /* ---------- Recurring Transactions ---------- */
    $('manageRecurringBtn')?.addEventListener('click', () => { renderRecurringList(); showModal('recurringModal'); });
    function renderRecurringList() {
        $('#recurringList').innerHTML = (state.recurring || []).map(r => `<div class="row" style="justify-content:space-between; padding: 4px 0;" data-id="${r.id}"><span>${escapeHtml(r.description)} (${fmt(r.amount)}) - Prossima: ${r.nextDueDate}</span><div><button class="btn-sm" data-action="run-now" data-id="${r.id}" title="Esegui ora">▶️</button><button class="btn-sm" data-action="delete-rec" data-id="${r.id}" title="Elimina">🗑️</button></div></div>`).join('') || "<p>Nessuna transazione ricorrente.</p>";
    }
    $('#recurringList')?.addEventListener('click', e => {
        const btn = e.target.closest('button[data-action]'); if (!btn) return;
        const id = btn.dataset.id; const action = btn.dataset.action;
        if (action === 'delete-rec') {
            state.recurring = (state.recurring || []).filter(r => String(r.id) != String(id));
            save(); renderRecurringList();
        } else if (action === 'run-now') {
            const rec = (state.recurring || []).find(r => String(r.id) === String(id));
            if (rec) { addTransaction({ date: nowISO(), description: rec.description, amount: rec.amount, type: rec.amount >= 0 ? 'income' : 'expense', category: rec.category || guessCategory(rec.description) }); showToast(`Eseguita ricorrente: ${rec.description}`); }
        }
    });
    $('rAdd')?.addEventListener('click', () => {
        const desc = $('#rDesc').value.trim(), amt = parseAmount($('#rAmt').value), freq = $('#rFreq').value, date = $('#rDate').value;
        if (!desc || isNaN(amt) || !date) return showToast('Compila tutti i campi.');
        if (!state.recurring) state.recurring = [];
        state.recurring.push({ id: 'rec_' + Date.now(), description: desc, amount: amt, type: amt >= 0 ? 'income' : 'expense', frequency: freq, nextDueDate: date, category: guessCategory(desc) });
        save(); renderRecurringList(); $('#rDesc').value = ''; $('#rAmt').value = ''; $('#rDate').value = '';
    });

    /* ---------- Calendar ---------- */
    function renderCalendar() {
        const year = calendarCurrentDate.getFullYear(), month = calendarCurrentDate.getMonth();
        $('#calendar-month-year').textContent = new Date(year, month).toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });
        const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0); const startDayOfWeek = (firstDay.getDay() + 6) % 7, daysInMonth = lastDay.getDate();
        const grid = $('#calendar-grid'), weekdays = $('#calendar-weekdays'); grid.innerHTML = ''; weekdays.innerHTML = '';
        ['Lun','Mar','Mer','Gio','Ven','Sab','Dom'].forEach(d => { const dn = document.createElement('div'); dn.textContent=d; weekdays.appendChild(dn); });
        for (let i = 0; i < startDayOfWeek; i++) grid.insertAdjacentHTML('beforeend', `<div class="calendar-day other-month"></div>`);
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = document.createElement('div'); dayEl.className='calendar-day'; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            dayEl.dataset.date = dateStr; const dayTx = state.transactions.filter(t => t.date === dateStr);
            const income = dayTx.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0); const expense = dayTx.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            let summaryHtml = '<div class="day-summary" style="font-size:0.75rem; text-align:right;">';
            if(income > 0) summaryHtml += `<div style="color:var(--success)">+${fmt(income)}</div>`; if(expense < 0) summaryHtml += `<div style="color:var(--danger">${fmt(expense)}</div>`;
            summaryHtml += '</div>'; dayEl.innerHTML = `<div class="day-number">${day}</div>${summaryHtml}`; grid.appendChild(dayEl);
        }
    }
    $('#prev-month-btn')?.addEventListener('click', () => { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1); renderCalendar(); });
    $('#next-month-btn')?.addEventListener('click', () => { calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1); renderCalendar(); });
    $('#calendar-grid')?.addEventListener('click', e => {
        const dayEl = e.target.closest('.calendar-day'); if(!dayEl || !dayEl.dataset.date) return;
        const date = dayEl.dataset.date, dayTx = state.transactions.filter(t => t.date === date);
        $('#dayDetailTitle').textContent = `Dettagli per ${new Date(date+'T00:00:00').toLocaleDateString('it-IT',{weekday:'long', day:'numeric', month:'long'})}`;
        $('#dayDetailList').innerHTML = dayTx.length > 0 ? dayTx.map(t => `<div class="row" style="justify-content:space-between;padding: 4px 0;"><span>${state.categories.find(c=>c.name===t.category)?.icon||'🏷️'} ${escapeHtml(t.description)}</span><span class="${t.type}">${fmt(t.amount)}</span></div>`).join('') : '<p>Nessuna transazione.</p>';
        showModal('dayDetailModal');
    });

    /* ---------- Search / Filter interactions ---------- */
    $('#txSearch')?.addEventListener('input', e => renderTransactionList(e.target.value || '', $('#categoryFilter')?.value || ''));
    $('#categoryFilter')?.addEventListener('change', e => renderTransactionList($('#txSearch')?.value || '', e.target.value || ''));
    
    /* ---------- PWA Installation ---------- */
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault(); state.deferredInstallPrompt = e; $('#installBtn').classList.remove('hidden');
    });
    $('#installBtn').addEventListener('click', async () => {
        const promptEvent = state.deferredInstallPrompt; if (!promptEvent) return;
        promptEvent.prompt(); const { outcome } = await promptEvent.userChoice;
        console.log(`User response to the install prompt: ${outcome}`); state.deferredInstallPrompt = null; $('#installBtn').classList.add('hidden');
    });

    /* ---------- Service Worker Registration for Offline Capability ---------- */
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            const swContent = `
                const CACHE_NAME = 'finanza-pwa-cache-v1';
                const urlsToCache = [ './', 'https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.js', 'https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js' ];
                self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(urlsToCache))));
                self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request).catch(() => caches.match('./')))));
            `;
            const blob = new Blob([swContent], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob))
                .then(reg => console.log('Service Worker registered.'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    }

    /* ---------- Init ---------- */
    async function init() {
        load(); ensureDefaults(); updateUI();
        registerServiceWorker();
        if (!state.transactions.length) {
            addTransaction({date:nowISO(),description:'Stipendio Esempio',amount:2500,type:'income',category:'Stipendio'});
            addTransaction({date:nowISO(),description:'Spesa di Esempio',amount:-74.23,type:'expense',category:'Supermercato'});
        }
    }
    init();

})();
</script>
</body>
</html>
